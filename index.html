<!DOCTYPE html>
<html>
<head>
  <title>Word Difficulty Rating</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
      background: #fafafa;
    }
    #word {
      width: 520px;
      height: 100px;
      margin: 20px auto;
      background: #fff;
      border: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 48px;
    }
    .word-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    .rating-button, #start-btn {
      font-size: 14px;
      font-weight: 600;
      color: #555;
      padding: 16px;
      margin: 8px;
      min-width: 115px;
      cursor: pointer;
      border: solid 1px #e7e7e7;
      border-radius: 2px;
      background-color: #fff;
      transition: background-color 0.2s;
    }
    .rating-button:hover:not(:disabled),
    #start-btn:hover:enabled {
      background-color: #fafafa;
      border: solid 1px #ccc;
    }
    .rating-button:disabled,
    #start-btn:disabled,
    #next-btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    .rating-button.selected {
      background-color: #e0e0e0;
      border: solid 1px #999;
    }
    .letter.selectable { 
      cursor: pointer; 
      transition: color 0.2s, font-size 0.2s;
    }
    .letter.selectable:hover { color: rgb(20, 88, 197); }
    .letter.clicked { 
      color: rgb(200, 17, 17); 
      font-weight: bold;
      font-size: 52px;
    }
    #next-btn, #submit-btn {
      margin: 20px 10px 0;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    #next-btn:hover:not(:disabled), #submit-btn:hover:not(:disabled) {
      background-color: #f5f5f5;
    }
    #rating-instruction {
      font-size: 17px;
      color: #555;
      margin-top: 15px;
    }
    .clear-text {
      color: gray;
      cursor: pointer;
      text-decoration: underline;
    }
    #participantId {
      width: 400px;
      height: 20px;
      font-size: 16px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #text-explanation {
      display: none;
      margin-top: 25px;
    }
    #difficultyReason {
      width: 510px;
      height: 65px;
      font-size: 16px;
      font-family: Arial, sans-serif;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px;
      resize: vertical;
    }
    #no-letter-option {
      font-size: 14px;
      color: #555;
      margin-top: 35px;
      cursor: pointer;
      text-decoration: underline;
    }
    #no-letter-option:hover {
      color: #333;
    }
    .error-message {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 10px;
    }
    .success-message {
      color: #2e7d32;
      font-size: 16px;
      margin-top: 10px;
    }
    .task-completed #difficulty-question {
      display: none !important;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="id-input-section">
    <h2 for="participantId">Enter your Prolific ID:</h2><br>
    <input type="text" id="participantId" placeholder="Enter your Prolific ID"
           pattern="[A-Za-z0-9]{22,24}" maxlength="24" minlength="22" required
           title="Please enter a valid 22â€“24 character Prolific ID."
           oninput="validateProlificId()"><br><br>
    <button id="start-btn" onclick="startTask()" disabled>Start</button>
  </div>
  <div id="main-task" style="display: none;">
    <h2 id="difficulty-question">What is your level of difficulty in reading this word?</h2>
    <div id="word"></div>
    <div id="rating-buttons">
      <button class="rating-button" data-rating="1" onclick="rateWord(1)">Very Easy (1)</button>
      <button class="rating-button" data-rating="2" onclick="rateWord(2)">Easy (2)</button>
      <button class="rating-button" data-rating="3" onclick="rateWord(3)">Hard (3)</button>
      <button class="rating-button" data-rating="4" onclick="rateWord(4)">Very Hard (4)</button>
    </div>
    <div id="rating-instruction" style="display: none;">
      Click the <b>letters</b> in the word above that you found hard to read. <span id="clear" class="clear-text">[reset selected letters]</span>
    </div>
    <div id="no-letter-option" style="display: none;">If there is no specific letter to select, <u>click here to explain why</u></div>
    <div id="text-explanation" style="display: none;">
      <textarea id="difficultyReason" placeholder="Please explain why this word is hard to read (minimum 10 characters)." 
          oninput="checkNextButtonState()" maxlength="500"></textarea>
      <div id="char-count" style="font-size: 12px; color: #666; margin-top: 5px;">0/500 characters (minimum 10)</div>
    </div>
    <div id="error-container"></div>
    <div>
      <button id="next-btn" onclick="goToNextWord()" disabled>Proceed to the next word</button>
      <button id="submit-btn" onclick="submitResults()" style="display: none;">Submit All Responses</button>
    </div>
    <div id="result"></div>
  </div>

  <script defer>
    let participantId = "";
    let words = [];
    let currentIndex = 0;
    let startTime = Date.now();
    let responses = [];
    let currentPhase = "rating"; 
    let previousRating = null;
    const participantUrl = document.referrer || "Direct";
    const MIN_EXPLANATION_LENGTH = 10;
    let userCount = parseInt(localStorage.getItem('userCount') || '0');
    let currentSubset = 0;
    let featureCounts = {
      long_words: 0,
      diagraphs: 0,
      not_freq_words: 0,
      silent_letters: 0,
      vowel_digraphs: 0,
      has_homophones: 0,
      difficult_orthography: 0
    };

    // Increment user count and assign subset (1-23, cycles)
    userCount++;
    localStorage.setItem('userCount', userCount);
    currentSubset = ((userCount - 1) % 23) + 1;

    // Load JSON data on page load
    document.addEventListener('DOMContentLoaded', () => {
      fetch('data.json')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          words = Object.entries(data)
            .filter(([word, info]) => info.subset === currentSubset)
            .map(([word, info]) => ({
              word,
              features: {
                long_words: info.long_words,
                diagraphs: info.diagraphs,
                not_freq_words: info.not_freq_words,
                silent_letters: info.silent_letters,
                vowel_digraphs: info.vowel_digraphs,
                has_homophones: info.has_homophones,
                difficult_orthography: info.difficult_orthography
              }
            }));
          // Re-validate to enable start button if ID is valid
          validateProlificId();
        })
        .catch(error => {
          console.error('Error loading JSON:', error);
          alert('Failed to load data.json. Check the console for details.');
        });
    });

    function validateProlificId() {
      const input = document.getElementById("participantId").value.trim();
      const isValid = /^[A-Za-z0-9]{22,24}$/.test(input);
      const startBtn = document.getElementById("start-btn");
      startBtn.disabled = !isValid || words.length === 0;
    }

    function startTask() {
      participantId = document.getElementById("participantId").value.trim();
      if (words.length === 0) {
        alert("Data is still loading or failed to load. Please check the console for errors.");
        return;
      }
      document.getElementById("id-input-section").style.display = "none";
      document.getElementById("main-task").style.display = "block";
      showWord();
    }

    function formatTimestamp(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function initializeResponse(index) {
      if (!responses[index]) {
        responses[index] = {
          word: words[index].word,
          clicked_letters: [],
          difficulty: null,
          time_seconds: null,
          reason: "",
          participants_url: participantUrl,
          timestamp: formatTimestamp(new Date()),
          rating_sequence: [],
          features: words[index].features
        };
      }
    }

    function showWord() {
      const wordBox = document.getElementById("word");
      const instruction = document.getElementById("rating-instruction");
      const nextBtn = document.getElementById("next-btn");
      const submitBtn = document.getElementById("submit-btn");
      const explanationBox = document.getElementById("text-explanation");
      const noLetterOption = document.getElementById("no-letter-option");
      const reasonInput = document.getElementById("difficultyReason");
      const errorContainer = document.getElementById("error-container");

      wordBox.innerHTML = "";
      instruction.style.display = "none";
      nextBtn.disabled = true;
      explanationBox.style.display = "none";
      noLetterOption.style.display = "none";
      reasonInput.value = "";
      errorContainer.innerHTML = "";
      currentPhase = "rating";
      previousRating = null;

      document.querySelectorAll(".rating-button").forEach(btn => {
        btn.classList.remove("selected");
        btn.disabled = false;
        btn.style.display = "inline-block";
      });

      if (currentIndex < words.length) {
        const currentWord = words[currentIndex].word;
        const wordContainer = document.createElement("div");
        wordContainer.classList.add("word-container");

        [...currentWord].forEach((char, index) => {
          const span = document.createElement("span");
          span.textContent = char;
          span.classList.add("letter");
          span.dataset.index = index;
          wordContainer.appendChild(span);
        });

        wordBox.appendChild(wordContainer);
        initializeResponse(currentIndex);
        submitBtn.style.display = "none";
        nextBtn.style.display = "inline-block";
        startTime = Date.now();
      } else {
        document.getElementById("main-task").classList.add("task-completed");
        wordBox.innerHTML = "<h6>All words completed!</h6>";
        submitBtn.style.display = "inline-block";
        nextBtn.style.display = "none";
        document.querySelectorAll(".rating-button").forEach(btn => btn.style.display = "none");
      }
    }

    function clearAllSelections() {
      const letters = document.querySelectorAll("#word .letter");
      letters.forEach(span => {
        span.classList.remove("selectable", "clicked");
        span.onclick = null;
      });
      document.getElementById("difficultyReason").value = "";
      updateCharCount();
      if (responses[currentIndex]) {
        responses[currentIndex].clicked_letters = [];
        responses[currentIndex].reason = "";
      }
    }

    function rateWord(rating) {
      const timeTaken = (Date.now() - startTime) / 1000;
      document.querySelectorAll(".rating-button").forEach(btn => {
        btn.classList.remove("selected");
        if (parseInt(btn.dataset.rating) === rating) btn.classList.add("selected");
      });

      initializeResponse(currentIndex);
      const wasHard = previousRating && previousRating >= 3;
      const isHard = rating >= 3;

      if ((wasHard && !isHard) || (!wasHard && isHard)) {
        clearAllSelections();
      }

      responses[currentIndex].rating_sequence.push(rating);
      responses[currentIndex].difficulty = responses[currentIndex].rating_sequence.join(',');
      responses[currentIndex].time_seconds = timeTaken;

      if (rating >= 3) {
        for (let feature in words[currentIndex].features) {
          if (words[currentIndex].features[feature] === 1) {
            featureCounts[feature]++;
          }
        }
      }

      previousRating = rating;
      document.getElementById("rating-instruction").style.display = "none";
      document.getElementById("no-letter-option").style.display = "none";
      document.getElementById("text-explanation").style.display = "none";

      if (rating <= 2) {
        currentPhase = "rating";
        document.getElementById("next-btn").disabled = false;
      } else {
        currentPhase = "letter-selection";
        document.getElementById("rating-instruction").style.display = "block";
        document.getElementById("no-letter-option").style.display = "block";
        enableLetterSelection();
        const hasLetterSelections = responses[currentIndex].clicked_letters.length > 0;
        const hasExplanation = responses[currentIndex].reason.trim().length >= MIN_EXPLANATION_LENGTH;
        if (hasExplanation) {
          showExplanationBox();
          document.getElementById("difficultyReason").value = responses[currentIndex].reason;
          updateCharCount();
        }
        document.getElementById("next-btn").disabled = !(hasLetterSelections || hasExplanation);
      }
      clearError();
    }

    function enableLetterSelection() {
      const letters = document.querySelectorAll("#word .letter");
      letters.forEach(span => {
        span.classList.add("selectable");
        const idx = parseInt(span.dataset.index);
        const isSelected = responses[currentIndex].clicked_letters.some(l => l.position === idx);
        if (isSelected) span.classList.add("clicked");
        span.onclick = () => {
          if (span.classList.contains("clicked")) {
            span.classList.remove("clicked");
            responses[currentIndex].clicked_letters = responses[currentIndex].clicked_letters.filter(l => l.position !== idx);
          } else {
            span.classList.add("clicked");
            responses[currentIndex].clicked_letters.push({ 
              letter: span.textContent, 
              position: idx 
            });
          }
          checkNextButtonState();
        };
      });
      const clearLink = document.getElementById("clear");
      if (clearLink) clearLink.onclick = resetLetterSelection;
    }

    function resetLetterSelection() {
      const letters = document.querySelectorAll("#word .letter");
      letters.forEach(span => span.classList.remove("clicked"));
      responses[currentIndex].clicked_letters = [];
      document.getElementById("text-explanation").style.display = "none";
      document.getElementById("difficultyReason").value = "";
      responses[currentIndex].reason = "";
      currentPhase = "letter-selection";
      document.getElementById("rating-instruction").style.display = "block";
      document.getElementById("rating-instruction").innerHTML = 'Click the <b>letters</b> in the word above that you found hard to read. <span id="clear" class="clear-text">[reset selected letters]</span>';
      document.getElementById("no-letter-option").style.display = "block";
      enableLetterSelection();
      checkNextButtonState();
    }

    function showExplanationBox() {
      currentPhase = "text-explanation";
      document.getElementById("text-explanation").style.display = "block";
      document.getElementById("no-letter-option").style.display = "none";
      document.getElementById("rating-instruction").innerHTML = "Please explain why this word is hard to read: <span id='clear' class='clear-text'>[reset and go back to letter selection]</span>";
      const letters = document.querySelectorAll("#word .letter");
      letters.forEach(span => {
        span.classList.remove("selectable");
        span.onclick = null;
      });
      document.getElementById("difficultyReason").focus();
      const clearLink = document.getElementById("clear");
      if (clearLink) clearLink.onclick = resetLetterSelection;
      updateCharCount();
      checkNextButtonState();
    }

    function updateCharCount() {
      const reasonText = document.getElementById("difficultyReason").value;
      const charCount = document.getElementById("char-count");
      const remaining = 500 - reasonText.length;
      const isValid = reasonText.length >= MIN_EXPLANATION_LENGTH;
      charCount.textContent = `${reasonText.length}/500 characters (minimum ${MIN_EXPLANATION_LENGTH})`;
      charCount.style.color = isValid ? "#2e7d32" : "#666";
    }

    function checkNextButtonState() {
      const nextBtn = document.getElementById("next-btn");
      let canProceed = false;
      if (currentPhase === "rating") {
        canProceed = responses[currentIndex] && responses[currentIndex].difficulty <= 2;
      } else if (currentPhase === "letter-selection") {
        canProceed = responses[currentIndex].clicked_letters.length > 0;
      } else if (currentPhase === "text-explanation") {
        const reasonText = document.getElementById("difficultyReason").value.trim();
        canProceed = reasonText.length >= MIN_EXPLANATION_LENGTH;
        responses[currentIndex].reason = reasonText;
        updateCharCount();
      }
      nextBtn.disabled = !canProceed;
    }

    function showError(message) {
      document.getElementById("error-container").innerHTML = `<div class="error-message">${message}</div>`;
    }

    function clearError() {
      document.getElementById("error-container").innerHTML = "";
    }

    function goToNextWord() {
      if (currentPhase === "text-explanation") {
        const reasonText = document.getElementById("difficultyReason").value.trim();
        if (reasonText.length < MIN_EXPLANATION_LENGTH) {
          showError(`Please provide at least ${MIN_EXPLANATION_LENGTH} characters of explanation.`);
          return;
        }
        responses[currentIndex].reason = reasonText;
      } else if (currentPhase === "letter-selection" && responses[currentIndex].clicked_letters.length === 0) {
        showError("Please select at least one letter or provide a text explanation.");
        return;
      }
      currentIndex++;
      showWord();
    }

    function getRatingText(rating) {
      switch (rating) {
        case 1: return "Very Easy";
        case 2: return "Easy";
        case 3: return "Hard";
        case 4: return "Very Hard";
        default: return "";
      }
    }

    function submitResults() {
      const submitBtn = document.getElementById("submit-btn");
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      let maxFeature = "";
      let maxCount = 0;
      for (let feature in featureCounts) {
        if (featureCounts[feature] > maxCount) {
          maxCount = featureCounts[feature];
          maxFeature = feature;
        }
      }

      document.getElementById("result").innerHTML = maxFeature
        ? `Most common difficulty feature: ${maxFeature.replace('_', ' ')} (${maxCount} occurrences)`
        : "No features were rated as Hard or Very Hard.";

      const url = `https://script.google.com/macros/s/AKfycbwtxXb5rlg_AQ8C2HWC-oOFEvgJTcd3QiHLGUllwuy9NPVpRM8bf04A9pgMsRifVx0l/exec?participant=${participantId}`;

      fetch(url, {
        method: "POST",
        body: JSON.stringify(responses)
      })
      .then(res => res.text())
      .then(response => {
        document.body.innerHTML = `
          <div style="text-align: center; margin-top: 150px; font-family: Arial, sans-serif;">
            <h1>Thank you for your participation!</h1>
            <p>${maxFeature ? `Most common difficulty feature: ${maxFeature.replace('_', ' ')} (${maxCount} occurrences)` : "No features were rated as Hard or Very Hard."}</p>
          </div>
        `;
      })
      .catch(error => {
        console.warn("Submission may have failed.");
        console.error("Error details:", error);
        document.body.innerHTML = `
          <div style="text-align: center; margin-top: 150px; font-family: Arial, sans-serif;">
            <h1>Thank you for your participation!</h1>
            <p>${maxFeature ? `Most common difficulty feature: ${maxFeature.replace('_', ' ')} (${maxCount} occurrences)` : "No features were rated as Hard or Very Hard."}</p>
          </div>
        `;
      });
    }

    document.addEventListener('keydown', (event) => {
      const key = event.key;
      if (key === 'Enter') {
        const idInputSection = document.getElementById("id-input-section");
        const mainTask = document.getElementById("main-task");
        if (idInputSection.style.display !== "none") {
          const startBtn = document.getElementById("start-btn");
          if (!startBtn.disabled) {
            event.preventDefault();
            startTask();
            return;
          }
        }
        if (mainTask.style.display === "block") {
          if (event.target.tagName === 'TEXTAREA') return;
          const nextBtn = document.getElementById("next-btn");
          const submitBtn = document.getElementById("submit-btn");
          if (!nextBtn.disabled && nextBtn.style.display !== "none") {
            event.preventDefault();
            goToNextWord();
          } else if (!submitBtn.disabled && submitBtn.style.display !== "none") {
            event.preventDefault();
            submitResults();
          }
        }
      }
      const mainTask = document.getElementById("main-task");
      if (mainTask.style.display !== "block") return;
      if (['1', '2', '3', '4'].includes(key)) {
        if (event.target.tagName === 'TEXTAREA') return;
        const rating = parseInt(key);
        if (currentIndex < words.length) {
          rateWord(rating);
        }
      }
    });

    document.getElementById("difficultyReason").addEventListener('input', updateCharCount);
    document.getElementById("no-letter-option").onclick = showExplanationBox;
  </script>
</body>
</html>
